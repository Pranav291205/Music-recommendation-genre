<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Music Recommender</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1DB954; /* Spotify Green */
            --background-dark: #121212;
            --card-dark: #181818;
            --text-light: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #282828;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--card-dark);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        h1 {
            text-align: center;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        /* --- Search & Input --- */
        #search-container { margin-bottom: 20px; }

        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            box-sizing: border-box;
            background-color: var(--background-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* --- Button --- */
        button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px 15px;
            margin-top: 25px;
            background-color: var(--primary-color);
            color: var(--background-dark);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 0.5px;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:hover {
            background-color: #1ed760; /* Slightly lighter green */
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* --- Result Section --- */
        #recommendation-result {
            margin-top: 40px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--background-dark);
            border: 1px solid var(--border-color);
        }

        .result-header {
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
        }

        #predicted-genre {
            color: var(--primary-color);
            font-weight: 600;
        }

        ul { list-style-type: none; padding: 0; }

        li {
            display: flex; /* Use flexbox for layout */
            align-items: center; /* Vertically center items */
            padding: 10px 0;
            border-bottom: 1px dotted var(--border-color);
            font-size: 15px;
        }

        li:last-child {
            border-bottom: none; /* No border for the last item */
        }

        li .album-art-thumbnail {
            width: 50px; /* Size for thumbnail */
            height: 50px;
            border-radius: 4px; /* Slightly rounded corners for album art */
            margin-right: 15px;
            object-fit: cover; /* Ensure image covers the area */
            flex-shrink: 0; /* Prevent image from shrinking */
        }

        li .song-details {
            flex-grow: 1; /* Allow details to take remaining space */
        }

        li strong {
            color: var(--text-light);
            font-weight: 600;
        }

        /* --- Loading Spinner --- */
        .spinner {
            border: 4px solid var(--text-secondary);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ§ AI Music Recommender</h1>
        <form id="recommendationForm">
            <div id="search-container">
                <label for="song-search">Select a Track to Analyze (Type to see suggestions):</label>
                <input type="text" id="song-search" list="songs-list" placeholder="Search by name or artist..." required>
                <datalist id="songs-list"></datalist>
            </div>
            <button type="submit" id="submit-button" disabled>
                <div class="spinner" id="form-spinner"></div>
                Analyze Class & Recommend Songs
            </button>
        </form>

        <div id="recommendation-result">
            <div class="result-header">
                Selected Song: <span id="selected-song" style="color: var(--text-light);">N/A</span>
                <br>
                Predicted Class: <span id="predicted-genre">Awaiting selection...</span>
            </div>

            <strong>Recommendations (5 Tracks in the same Class):</strong>
            <ul id="recommendations-list">
                <li>Waiting for song list to load...</li>
            </ul>
        </div>
    </div>

    <script>
        const songSearchInput = document.getElementById('song-search');
        const songListDatalist = document.getElementById('songs-list');
        const form = document.getElementById('recommendationForm');
        const submitButton = document.getElementById('submit-button');
        const formSpinner = document.getElementById('form-spinner');
        const selectedSongSpan = document.getElementById('selected-song');
        const predictedGenreSpan = document.getElementById('predicted-genre');
        const recommendationsList = document.getElementById('recommendations-list');
        let allSongs = [];

        // Function to get a random placeholder image
        function getRandomAlbumArt() {
            const width = 100;
            const height = 100;
            const randomSeed = Math.floor(Math.random() * 1000);
            return `https://picsum.photos/seed/${randomSeed}/${width}/${height}`;
        }

        // 1. Function to fetch and load song names into the datalist
        async function fetchSongs() {
            predictedGenreSpan.textContent = 'Loading song list...';
            recommendationsList.innerHTML = '<li>Loading song list...</li>';
            submitButton.disabled = true;

            try {
                // Fetch data from Flask backend API
                const response = await fetch('/api/songs'); 
                
                let fetchedSongs;
                
                if (response.ok) {
                    fetchedSongs = await response.json();
                } else {
                    throw new Error(`Server returned status ${response.status}.`);
                }

                if (!Array.isArray(fetchedSongs) || fetchedSongs.length === 0) {
                    throw new Error("No songs were loaded, check the Flask /api/songs route.");
                }

                // Prepare and store song data, ensuring image URLs (or placeholders) are present
                allSongs = fetchedSongs.map(song => ({
                    ...song,
                    // If the backend doesn't provide an image, use a placeholder
                    imageUrl: song.imageUrl || getRandomAlbumArt() 
                }));
                
                // Build options for the datalist (the suggestions dropdown)
                let optionsHtml = '';
                for (const song of allSongs) {
                    if (song.title && song.artist) {
                        optionsHtml += '<option value="' + song.title + ' by ' + song.artist + '">';
                    }
                }
                songListDatalist.innerHTML = optionsHtml;
                
                predictedGenreSpan.textContent = `Ready. Loaded ${allSongs.length} songs.`;
                recommendationsList.innerHTML = '<li>Start by selecting a song above.</li>';
                submitButton.disabled = false; // Enable button once songs are available

            } catch (error) {
                console.error('Error fetching songs:', error);
                predictedGenreSpan.textContent = `ERROR: Cannot load songs. Check the Flask /api/songs route. (${error.message})`;
                recommendationsList.innerHTML = '<li>Failed to load song list.</li>';
                submitButton.disabled = true;
            }
        }

        // 2. Event Listener for Form Submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitButton.disabled = true;
            formSpinner.style.display = 'block';

            const selectedText = songSearchInput.value.trim();
            if (!selectedText) {
                submitButton.disabled = false;
                formSpinner.style.display = 'none';
                return;
            }

            // Extract the song title by splitting the "Title by Artist" string
            const songTitle = selectedText.split(' by ')[0];
            const matchingSong = allSongs.find(song => song.title === songTitle);

            if (!matchingSong) {
                alert(`Please select a valid song from the suggestions list. You entered: "${selectedText}"`);
                submitButton.disabled = false;
                formSpinner.style.display = 'none';
                return;
            }
            
            selectedSongSpan.textContent = selectedText;
            predictedGenreSpan.textContent = 'Analyzing...';
            recommendationsList.innerHTML = '<li>Analyzing model and calculating recommendations...</li>';

            try {
                const response = await fetch('/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ song_title: songTitle })
                });

                if (!response.ok) {
                    // Check if Flask returns a non-JSON error (like an HTML error page)
                    const errorText = await response.text();
                    console.error('Backend returned non-JSON error:', errorText);
                    throw new Error(`Server returned HTTP status ${response.status}. Check Flask route /recommend.`);
                }
                
                // This line will now correctly parse the JSON response
                const result = await response.json();
                
                if (!result.recommendations || result.recommendations.length === 0) {
                    predictedGenreSpan.textContent = result.predicted_genre || "No Class Found";
                    throw new Error("Analysis complete, but the server returned zero recommendations.");
                }

                predictedGenreSpan.textContent = result.predicted_genre;
                
                // Render recommendations, ensuring image URLs are present
                recommendationsList.innerHTML = result.recommendations.map(song => {
                    // Use the imageUrl provided by the backend, or a random placeholder if missing
                    const imageUrl = song.imageUrl || getRandomAlbumArt();
                    return `
                        <li>
                            <img src="${imageUrl}" alt="Album art for ${song.title}" class="album-art-thumbnail">
                            <div class="song-details">
                                <strong>${song.title}</strong> by ${song.artist} (Class: ${result.predicted_genre})
                            </div>
                        </li>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error during recommendation:', error);
                // Display a clean error message to the user
                predictedGenreSpan.textContent = `ERROR: Recommendation failed.`;
                recommendationsList.innerHTML = `<li>Error: ${error.message}</li><li>**Action:** Ensure the selected song is in your database and the Flask backend is running correctly.</li>`;
            } finally {
                submitButton.disabled = false;
                formSpinner.style.display = 'none';
            }
        });
        
        // Initial call to load songs into the datalist on page load
        fetchSongs();

    </script>
</body>
</html>